import { useQuery, useMutation } from "convex/react";
import { api } from "@/convex/_generated/api";
import { Upload, Reply, MoreVertical } from "lucide-react";

export function TeamChat({ businessId }: { businessId: Id<"businesses"> }) {
  const [selectedChannel, setSelectedChannel] = useState<Id<"teamChatChannels"> | null>(null);
  const [replyingTo, setReplyingTo] = useState<Id<"teamChatMessages"> | null>(null);
  const [attachments, setAttachments] = useState<File[]>([]);
  
  // Real-time messages (Convex auto-updates)
  const messages = useQuery(
    api.teamChat.getRecentMessages,
    selectedChannel ? { channelId: selectedChannel, limit: 50 } : "skip"
  );
  
  const sendMessage = useMutation(api.teamChat.sendMessageWithAttachments);
  const generateUploadUrl = useMutation(api.files.generateUploadUrl);
  
  const handleSendMessage = async (content: string) => {
    if (!selectedChannel) return;
    
    // Upload attachments first
    const uploadedAttachments = [];
    for (const file of attachments) {
      const { uploadUrl, storageId } = await generateUploadUrl();
      await fetch(uploadUrl, { method: "POST", body: file });
      uploadedAttachments.push({
        fileId: storageId,
        fileName: file.name,
        fileSize: file.size,
        mimeType: file.type,
      });
    }
    
    await sendMessage({
      channelId: selectedChannel,
      content,
      attachments: uploadedAttachments.length > 0 ? uploadedAttachments : undefined,
      threadId: replyingTo || undefined,
    });
    
    setAttachments([]);
    setReplyingTo(null);
  };
  
  return (
    <div className="flex h-[600px]">
      {/* Channel list */}
      <div className="w-64 border-r">
        {/* ... channel list UI ... */}
      </div>
      
      {/* Messages area */}
      <div className="flex-1 flex flex-col">
        <ScrollArea className="flex-1 p-4">
          {messages?.map(msg => (
            <div key={msg._id} className="mb-4 group">
              <div className="flex items-start gap-2">
                <Avatar>
                  <AvatarFallback>{msg.senderName?.[0]}</AvatarFallback>
                </Avatar>
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <span className="font-semibold">{msg.senderName}</span>
                    <span className="text-xs text-muted-foreground">
                      {new Date(msg.createdAt).toLocaleTimeString()}
                    </span>
                  </div>
                  <p className="text-sm">{msg.content}</p>
                  
                  {/* Attachments */}
                  {msg.attachments?.map(att => (
                    <div key={att.fileId} className="mt-2 p-2 border rounded">
                      <a href={`/api/files/${att.fileId}`} download={att.fileName}>
                        {att.fileName} ({(att.fileSize / 1024).toFixed(1)} KB)
                      </a>
                    </div>
                  ))}
                  
                  {/* Thread indicator */}
                  {msg.replyCount && msg.replyCount > 0 && (
                    <Button 
                      size="sm" 
                      variant="ghost"
                      onClick={() => setReplyingTo(msg._id)}
                    >
                      {msg.replyCount} replies
                    </Button>
                  )}
                </div>
                
                {/* Actions */}
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button size="sm" variant="ghost" className="opacity-0 group-hover:opacity-100">
                      <MoreVertical className="h-4 w-4" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent>
                    <DropdownMenuItem onClick={() => setReplyingTo(msg._id)}>
                      <Reply className="h-4 w-4 mr-2" />
                      Reply in thread
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              </div>
            </div>
          ))}
        </ScrollArea>
        
        {/* Message input */}
        <div className="p-4 border-t">
          {replyingTo && (
            <div className="mb-2 p-2 bg-muted rounded flex items-center justify-between">
              <span className="text-sm">Replying to thread</span>
              <Button size="sm" variant="ghost" onClick={() => setReplyingTo(null)}>
                Cancel
              </Button>
            </div>
          )}
          
          <div className="flex gap-2">
            <Input
              placeholder="Type a message..."
              onKeyDown={(e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                  e.preventDefault();
                  handleSendMessage(e.currentTarget.value);
                  e.currentTarget.value = "";
                }
              }}
            />
            <Button size="icon" variant="outline" onClick={() => document.getElementById("file-upload")?.click()}>
              <Upload className="h-4 w-4" />
            </Button>
            <input
              id="file-upload"
              type="file"
              multiple
              className="hidden"
              onChange={(e) => setAttachments(Array.from(e.target.files || []))}
            />
          </div>
          
          {attachments.length > 0 && (
            <div className="mt-2 flex gap-2">
              {attachments.map((file, idx) => (
                <Badge key={idx} variant="secondary">
                  {file.name}
                  <button onClick={() => setAttachments(attachments.filter((_, i) => i !== idx))}>
                    Ã—
                  </button>
                </Badge>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}